# Notes on hacking this collection

## General notes for contributors

Tips for writing good contributions:

1. Write documentation.
    1. If you write a module, make sure there are `DOCUMENTATION`,`EXAMPLES`, and `RETURN` docstrings.
       Make sure that they parse correctly as YAML.
    1. Make sure that all options are documented.
    1. In the `EXAMPLES` docstring, include examples of all common use cases.
    1. In the `RETURN` docstring, make sure all return fields are documented.
1. Include tests.
    1. If you're adding or updating a module, a playbook that exercises your new functionality is useful, especially if it includes edge cases.

## Creating a new module

If you want to create a new module `foo`, start by copying the file
`extras/module-template` to `plugins/modules/foo.py`, then editing it.

Adapt `foo.py` to suit your purposes.

That template uses the generic term "resource" for the thing you're
managing. Change that to comething more descriptive: instead of
`resource_info`, use `user_info` in the user module, or `foo_info` in
the foo module, that sort of thing.

Be sure to fill in the `DOCUMENTATION`, `EXAMPLES`, and `RETURN`
strings. Documentation will be automatically generated from that,
using `make documentation`.

## Putting out a new release

1. Update `galaxy.yml` and update `version`.

1. Update `changelogs/changelog.yaml` and list changes the users care
about.
  - [Format documentation](https://ansible.readthedocs.io/projects/antsibull-changelog/changelog.yaml-format/).
  - [Changelog fields](https://ansible.readthedocs.io/projects/antsibull-changelog/changelogs/#changelog-fragment-categories).

1. If you added a module, add `version_added` to its `DOCUMENTATION` string.

1. Update `README.md` and `galaxy.xml` to add any new contributors.

1. Run `antsibull-changelog lint` and `antsibull-changelog release`.

1. Commit changes. Merge to `main` branch if necessary.

1. Close bug report or pull request if appropriate.

1. Tag the git commit with the new release version, in the format
`v1.2.3`.

1. `git push; git push --tags`

1. Create a release in github.

1. `make tarball`. Upload the new tarball to Ansible Galaxy.

1. `make documentation; make update-doc-site`. Push the docs out to the
web site.

1. Toast!

## Documentation

`antsibull-docs` is used to create and populate the `docs` directory:

    antsibull-docs sphinx-init --use-current --dest-dir new-docs arensb.truenas

This creates the `docs/build.sh` script, which is used to generate
documentation: it uses `antsibull-docs collection` to convert Python
module files into RST files in `docs/`, and then `sphinx-build` to
convert those RST files into HTML.

The files generated by `sphinx-build` go in `docs/build/`. That
directory can safely be deleted. In fact, if you make major changes
(including deleting modules), it's probably a good idea to delete
`docs/build/` and rebuild the documentation.

The generated HTML files can then be copied to `docs-site/`, which is
just a git repository of the
[documentation website](https://arensb.github.io/truenas/index.html).
So to update the online documentation:

1. `make update-doc-site`
2. `cd docs-site`
3. `git add .; git checkin -m "Documentation update"; git push`
